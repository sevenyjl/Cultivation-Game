# 代码约定（Godot 项目）

本约定用于统一生命周期、组件接口、信号命名和数据流边界，降低复杂度、去除轮询、提升可维护性与性能。

## 生命周期职责边界
- `_ready()`：构建/缓存节点引用、连接信号、初始化本地 UI 元素。不做跨层数据拉取。
- `_exit_tree()`：对称释放（断开信号、清理定时器/任务句柄、归还对象池）。
- `_process(delta)`：仅用于动画/拖拽/输入等需要每帧处理的场景。禁止用于常规 UI 刷新。

## 组件接口（统一使用 bind/unbind）
- `bind(model)`：仅绑定数据引用、连接模型信号，并进行首次渲染。
- `unbind()`：断开所有外部信号、清空引用。
- 组件的子组件由“控制器”统一下发 `bind`；禁止子组件反向获取上层节点。

示例模板（GDScript）：
```gdscript
extends Control

var model: Resource = null

func _ready() -> void:
    # 缓存 UI 节点/本地信号连接
    pass

func bind(m: Resource) -> void:
    if model == m: return
    unbind()
    model = m
    if model:
        if not model.changed.is_connected(_on_model_changed):
            model.changed.connect(_on_model_changed)
        _render()

func unbind() -> void:
    if model and model.changed.is_connected(_on_model_changed):
        model.changed.disconnect(_on_model_changed)
    model = null

func _exit_tree() -> void:
    unbind()

func _on_model_changed() -> void:
    _render()

func _render() -> void:
    if model == null: return
    # 根据 model 渲染 UI
```

## 信号命名规范
- 语义化且细粒度：`stats_changed`、`inventory_changed`、`battle_state_changed`。
- 事件过去式或状态变化：`item_added`、`item_removed`、`player_changed`。
- 避免泛化：不要使用 `data_changed` 这类过于宽泛的名称。

## 数据流边界（Store/事件驱动）
- `GameData` 作为 Store：
  - 对外暴露只读 getter 与修改方法（setter/操作），内部发信号。
  - UI 不得访问 `mainNode` 或其他 UI 实例。
  - UI 通过订阅 `GameData` 的信号获得更新，写操作统一调用 `GameData` 的 API。

示例（Store）：
```gdscript
extends Node
class_name GameDataStore

signal player_changed(player)
var _player: Resource

func get_player() -> Resource:
    return _player

func set_player(p: Resource) -> void:
    if _player == p: return
    _player = p
    player_changed.emit(_player)
```

## 用信号替代轮询 `_process`
- 模型属性变更触发信号，UI 只在信号触发时刷新。
- 高频更新用节流：信号 → 标记脏 → `Timer` 定期（5–10Hz）批量刷新。

示例（节流刷新）：
```gdscript
var _dirty := false
@onready var _throttle := Timer.new()

func _ready():
    _throttle.wait_time = 0.1
    _throttle.one_shot = false
    add_child(_throttle)
    _throttle.timeout.connect(func(): if _dirty: _render(); _dirty = false)

func _on_model_changed():
    _dirty = true
```

## 连接与释放规范
- 所有 `connect` 在 `_ready()`；对称 `disconnect` 在 `_exit_tree()` 或 `unbind()`。
- 连接前检查：`if not signal.is_connected(func_ref): connect(...)`。
- 解连接前检查：`if signal.is_connected(func_ref): disconnect(func_ref)`。
- 循环中批量连接时，避免重复绑定；不要在 `.bind(...)` 中捕获大对象。

## 列表/背包渲染（对象池）
```gdscript
var _pool: Array[Control] = []

func _get_item() -> Control:
    return _pool.pop_back() if _pool.size() > 0 else preload("res://Item.tscn").instantiate()

func _recycle_item(node: Control) -> void:
    node.hide()
    _pool.push_back(node)
```

## Tab/样式
- 推荐 `TabContainer` 或 `ButtonGroup` + Theme 状态，避免手写搬运 `StyleBox`。
- 如需自定义：仅应用“独立拷贝”的选中样式；切换前清理所有按钮覆盖。

## 错误处理与空值防御
- 所有公共 API 做参数校验与空值防御；失败返回值或报错统一处理。
- 信号回调内部避免抛异常，必要时捕获并记录到统一日志/提示。

## 类型与命名
- `class_name` 与文件名保持一致；尽量补全导出与本地变量类型注解。
- 中文 UI 命名允许，但 `class_name` 建议英文化以便检索与复用。


