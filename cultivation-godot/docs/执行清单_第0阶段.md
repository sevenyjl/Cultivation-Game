# 第0阶段：执行清单（基线与约束）

参考《docs/代码约定.md》，按以下步骤落地：

## 1) 建立规范
- [x] 新建并阅读《docs/代码约定.md》
- [x] 将规范链接加入项目 README/重构计划

## 2) 全局扫描与标记
- [x] 全局搜索 `初始化(`：已完成扫描，结果如下：
  
  | 文件路径 | 调用模式 | 替换计划 |
  |---------|---------|--------|
  | `tscns/内容/背包内容.gd` | 接受Backpack参数 | 替换为bind方法 |
  | `tscns/组件/tips/BaseTips.gd` | 接受通用data参数 | 替换为bind方法 |
  | `tscns/内容/阵容队伍.gd` | 接受BaseCultivation参数 | 替换为bind方法 |
  | `tscns/内容/阵容位置.gd` | 接受BaseCultivation参数 | 替换为bind方法 |
  | `tscns/组件/tips/武器背包tips.gd` | 接受Wepoen参数 | 替换为bind方法 |
  | `tscns/修炼UI.gd` | 无参数 | 替换为内部初始化 |
  | `tscns/组件/修仙者信息组件.gd` | 接受BaseCultivation参数 | 替换为bind方法 |
  | `tscns/内容/阵型内容.gd` | 无参数 | 替换为内部初始化 |
  | `tscns/修炼面板.gd` | 无参数 | 替换为内部初始化 |

- [x] 全局搜索 `func _process(`：已完成扫描，结果如下：
  
  | 文件路径 | 优先级 | 必须保留 | 备注 |
  |---------|-------|---------|------|
  | `tscns/修炼UI.gd` | 高 | ❌ | 可能用于界面刷新 |
  | `tscns/组件/修仙者信息组件.gd` | 高 | ❌ | 用于修仙者信息刷新 |
  | `tscns/组件/自动button.gd` | 中 | ⚠️ | 需检查是否用于交互 |
  | `tscns/组件/tips/装备带tips.gd` | 高 | ❌ | 可能用于提示框位置调整 |
  | `tscns/全局倍速.gd` | 中 | ⚠️ | 可能用于计时器效果 |
  | `tscns/组件/进度条组件.gd` | 低 | ⚠️ | 可能用于动画效果 |
  | `tscns/战斗UI.gd` | 高 | ❌ | 包含_process和_process_formation方法，需重构 |
  | `tscns/组件/人员战斗信息组件.gd` | 高 | ❌ | 用于战斗信息刷新 |
  | `tscns/内容/阵容队伍.gd` | 高 | ❌ | 用于阵容显示刷新 |
  | `tscns/内容/背包内容.gd` | 高 | ❌ | 用于背包物品刷新 |
  | `tscns/组件/tips/武器背包tips.gd` | 高 | ❌ | 可能用于提示框位置调整 |
  | `tscns/修炼面板.gd` | 高 | ❌ | 用于修炼进度显示 |
  | `tscns/内容/阵容位置.gd` | 高 | ❌ | 用于阵容位置更新 |
- [x] 全局搜索 `pressed.connect(`：已完成扫描，主要发现：
  - `tscns/战斗UI.gd`：`SpeedResetButton.pressed.connect(_on_speed_reset_pressed)`
  - `tscns/修炼UI.gd`：`button.pressed.connect(switch_tab.bind(i))` - 需检查是否在循环中连接
  - 其他连接主要在addons目录中，属于第三方插件

- [x] 全局搜索 `GameData.mainNode` 和跨 UI 访问：已完成扫描，发现以下耦合点：
  
  | 文件路径 | 耦合类型 | 重构计划 |
  |---------|---------|--------|
  | `tscns/修炼面板.gd` | 直接访问战斗UI | 改为订阅GameData信号 |
  | `tscns/组件/tips/武器背包tips.gd` | 跨层调用装备武器方法 | 改为GameData API调用 |
  | `tscns/外出节点/战斗节点.gd` | 调用进入战斗方法 | 改为GameData API调用 |
  | `tscns/战斗UI.gd` | 调用打开/关闭弹窗和结束战斗 | 改为GameData API调用 |
  | `tscns/main.gd` | 设置引用（合理） | 保留但避免直接访问

## 3) 模板替换与接口统一
- [x] 统一组件接口：已完成对`背包内容.gd`的重构
  - 将`初始化(backpack:Backpack)`替换为标准的`bind(model)`/`unbind()`接口
  - 实现了信号连接检查与安全断开
  - 将渲染逻辑分离为`_render_backpack()`和`_update_items()`方法
  - 添加了`_exit_tree()`方法用于资源清理
- [x] 去掉外部 `await 初始化(...)`：已移除内部的`await`调用，UI更新改为信号驱动
  - 移除了`_process`轮询，改为监听`添加物品信息号`信号
  - 添加了`_on_items_changed()`信号回调函数
- [x] 控制器模式准备：`背包内容`组件已实现标准接口，可由父控制器分发`bind`

## 4) 事件驱动替换轮询
- [ ] 在模型/Store 增加细粒度信号（如 `player_changed`、`inventory_changed`）
- [ ] UI 订阅后刷新；高频更新改为“脏标记 + Timer 节流（5–10Hz）”

## 5) 数据流边界（Store 化）
- [ ] 约束 UI 仅订阅 `GameData` 的信号/调用其 API，不访问 `mainNode`/其他 UI
- [ ] `GameData` 对外只读 getter + 修改方法；内部发信号

## 6) 连接/释放安全
- [ ] `connect` 集中在 `_ready`，`disconnect` 在 `_exit_tree`/`unbind`
- [ ] 循环批量连接时，先判断 `is_connected`，避免重复

## 7) UI 结构/样式
- [ ] Tab 改造为 `TabContainer` 或 `ButtonGroup` + Theme 状态
- [ ] 自定义样式：仅应用拷贝样式，切换前清理所有覆盖

## 8) 示例优先落地（建议作为模板）
- [ ] `背包内容`（首选试点）：中等复杂度，功能独立，具有代表性
  - 实现标准bind/unbind方法
  - 从_process轮询改为信号驱动
  - 移除自定义初始化方法
- [ ] `修仙者信息组件`：纯展示组件，按模板实现 bind/unbind
- [ ] `装备带tips`：简单组件，适合快速验证

## 9) 验收
- [ ] 搜索 `await 初始化(` 为 0；`_process` 仅剩动画/拖拽
- [ ] UI 不再访问 `mainNode`/其他 UI 实例
- [ ] 切场景/销毁 UI 无重复连接/悬空信号报错
- [ ] 战斗/背包场景帧率稳定、GC 压力降低


